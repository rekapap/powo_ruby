<section class="card">
  <h1 class="h1">Search</h1>
  <p class="muted">
    Endpoint: <code>/search</code>. Powered by <code>PowoRuby.powo.search.query</code>.
  </p>

  <% if defined?(@config_error) && @config_error %>
    <div class="alert alert--error">
      <strong>Config error:</strong> <%= h(@config_error) %>
    </div>
  <% end %>

  <% if defined?(@error) && @error %>
    <div class="alert alert--error">
      <strong>Error:</strong> <%= h(@error) %>
    </div>
  <% end %>

  <form method="get" action="/search" class="form">
    <div class="grid">
      <label class="field">
        <span class="field__label">Query (required)</span>
        <input class="field__input" type="text" name="q" value="<%= h(@query) %>" />
      </label>

      <label class="field">
        <span class="field__label">Per page</span>
        <input class="field__input" type="number" name="per_page" value="<%= h(@per_page) %>" min="1" max="500" />
      </label>

      <label class="field">
        <span class="field__label">Family</span>
        <input class="field__input" type="text" name="family" value="<%= h(@filters && @filters[:family]) %>" />
      </label>

      <label class="field">
        <span class="field__label">Genus</span>
        <input class="field__input" type="text" name="genus" value="<%= h(@filters && @filters[:genus]) %>" />
      </label>

      <label class="field">
        <span class="field__label">Accepted</span>
        <select class="field__input" name="accepted">
          <% selected = params["accepted"].to_s %>
          <option value="" <%= "selected" if selected.empty? %>>(any)</option>
          <option value="true" <%= "selected" if selected == "true" %>>true</option>
          <option value="false" <%= "selected" if selected == "false" %>>false</option>
        </select>
      </label>
    </div>

    <div class="actions">
      <button class="btn" type="submit">Search</button>
      <a class="btn btn--secondary" href="/">Back</a>
    </div>
  </form>
</section>

<% if defined?(@powo_response) && @powo_response %>
  <section class="card">
    <h2 class="h2">Results</h2>

    <% message = @powo_response.raw.is_a?(Hash) ? @powo_response.raw["message"] : nil %>
    <% if message && !message.to_s.strip.empty? %>
      <div class="alert alert--info">
        <strong>API message:</strong> <%= h(message) %>
      </div>
    <% end %>

    <div class="stats">
      <div><strong>Total:</strong> <%= h(@powo_response.total_count) %></div>
      <% if @powo_response.raw.is_a?(Hash) %>
        <div><strong>Page:</strong> <%= h(@powo_response.raw["page"] || @powo_response.raw[:page]) %></div>
        <div><strong>Total pages:</strong> <%= h(@powo_response.raw["totalPages"] || @powo_response.raw[:totalPages]) %></div>
        <div><strong>Cursor:</strong> <%= h(@cursor) %></div>
      <% end %>
    </div>

    <% if @powo_response.results.empty? %>
      <p class="muted">No results returned.</p>
    <% else %>
      <ol class="results">
        <% @powo_response.results.each do |row| %>
          <% ident = result_identifier(row) %>
          <li class="results__item">
            <div class="results__title">
              <%= h(result_title(row)) %>
            </div>
            <div class="results__meta">
              <span class="pill">id: <%= h(ident || "(none)") %></span>
              <% if ident %>
                <a class="link" href="/taxon?id=<%= ERB::Util.url_encode(ident) %>">Lookup</a>
              <% end %>
            </div>
            <details class="details">
              <summary>Raw row</summary>
              <pre class="pre"><%= h(pretty_json(row)) %></pre>
            </details>
          </li>
        <% end %>
      </ol>
    <% end %>

    <div class="actions">
      <% raw_cursor = @powo_response.raw.is_a?(Hash) ? (@powo_response.raw["cursor"] || @powo_response.raw[:cursor]) : nil %>
      <% next_cursor = raw_cursor.to_s.strip.empty? ? nil : raw_cursor.to_s %>

      <% if defined?(@prev_cursor) && !@prev_cursor.to_s.strip.empty? %>
        <a class="btn btn--secondary" href="/search?<%= Rack::Utils.build_query(params.merge('cursor' => @prev_cursor, 'prev_cursor' => '')) %>">Prev</a>
      <% end %>

      <% if next_cursor && next_cursor != "*" %>
        <a class="btn btn--secondary" href="/search?<%= Rack::Utils.build_query(params.merge('cursor' => next_cursor, 'prev_cursor' => @cursor)) %>">Next</a>
      <% else %>
        <span class="muted">No more pages.</span>
      <% end %>
    </div>
  </section>
<% end %>

